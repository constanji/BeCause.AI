# RAG 服务使用说明

## 概述

Because 项目中的 RAG（Retrieval-Augmented Generation）服务实现了完整的智能问答流程：

**问题向量化 → 语义模型/QA对/同义词/业务知识 向量检索 → 重排优化**

## 架构组件

### 1. 数据模型

- **KnowledgeEntry**: 知识库条目模型，支持以下类型：
  - `semantic_model`: 语义模型
  - `qa_pair`: QA对
  - `synonym`: 同义词
  - `business_knowledge`: 业务知识
  - `file`: 文件（兼容现有文件向量化）

### 2. 服务层

- **EmbeddingService**: 向量化服务，负责将文本转换为向量嵌入
- **KnowledgeBaseService**: 知识库管理服务，管理各种知识条目
- **RetrievalService**: 向量检索服务，从知识库中检索相关内容
- **RerankingService**: 重排服务，对检索结果进行优化排序
- **RAGService**: 主服务，整合所有功能

## API 端点

### 1. RAG 查询

**POST** `/api/rag/query`

查询相关知识并返回重排后的结果。

**请求体：**
```json
{
  "query": "用户的问题",
  "options": {
    "types": ["semantic_model", "qa_pair", "synonym", "business_knowledge"],
    "fileIds": ["file_id_1", "file_id_2"],
    "entityId": "entity_id",
    "topK": 10,
    "useReranking": true,
    "enhancedReranking": false
  }
}
```

**响应：**
```json
{
  "query": "用户的问题",
  "results": [
    {
      "rank": 1,
      "type": "qa_pair",
      "title": "QA: 问题示例",
      "content": "问题: 示例问题\n答案: 示例答案",
      "score": 0.95,
      "question": "示例问题",
      "answer": "示例答案",
      "metadata": {}
    }
  ],
  "total": 1,
  "metadata": {
    "retrievalCount": 5,
    "reranked": true,
    "enhancedReranking": false
  }
}
```

### 2. 添加知识条目

**POST** `/api/rag/knowledge`

添加单个知识条目到知识库。

**请求体：**
```json
{
  "type": "qa_pair",
  "data": {
    "question": "什么是RAG？",
    "answer": "RAG是检索增强生成技术",
    "entityId": "optional_entity_id"
  }
}
```

**支持的知识类型：**

#### 语义模型 (semantic_model)
```json
{
  "type": "semantic_model",
  "data": {
    "semanticModelId": "model_id",
    "databaseName": "database_name",
    "tableName": "table_name",
    "content": "语义模型内容（JSON字符串或文本）",
    "entityId": "optional_entity_id"
  }
}
```

#### QA对 (qa_pair)
```json
{
  "type": "qa_pair",
  "data": {
    "question": "问题",
    "answer": "答案",
    "entityId": "optional_entity_id"
  }
}
```

#### 同义词 (synonym)
```json
{
  "type": "synonym",
  "data": {
    "noun": "名词",
    "synonyms": ["同义词1", "同义词2"],
    "entityId": "optional_entity_id"
  }
}
```

#### 业务知识 (business_knowledge)
```json
{
  "type": "business_knowledge",
  "data": {
    "title": "标题",
    "content": "内容",
    "category": "分类",
    "tags": ["标签1", "标签2"],
    "entityId": "optional_entity_id"
  }
}
```

### 3. 批量添加知识条目

**POST** `/api/rag/knowledge/batch`

批量添加知识条目。

**请求体：**
```json
{
  "entries": [
    {
      "type": "qa_pair",
      "question": "问题1",
      "answer": "答案1"
    },
    {
      "type": "synonym",
      "noun": "名词",
      "synonyms": ["同义词1", "同义词2"]
    }
  ]
}
```

### 4. 获取知识条目列表

**GET** `/api/rag/knowledge`

获取用户的知识条目列表。

**查询参数：**
- `type`: 知识类型过滤
- `entityId`: 实体ID过滤
- `limit`: 限制数量（默认100）
- `skip`: 跳过数量（默认0）

### 5. 删除知识条目

**DELETE** `/api/rag/knowledge/:id`

删除指定的知识条目。

## 使用示例

### 示例1: 添加QA对并查询

```javascript
// 1. 添加QA对
const response1 = await fetch('/api/rag/knowledge', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_JWT_TOKEN'
  },
  body: JSON.stringify({
    type: 'qa_pair',
    data: {
      question: '什么是向量数据库？',
      answer: '向量数据库是专门用于存储和检索高维向量的数据库系统。'
    }
  })
});

// 2. 查询
const response2 = await fetch('/api/rag/query', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_JWT_TOKEN'
  },
  body: JSON.stringify({
    query: '向量数据库是什么？',
    options: {
      types: ['qa_pair'],
      topK: 5,
      useReranking: true
    }
  })
});
```

### 示例2: 添加语义模型

```javascript
const response = await fetch('/api/rag/knowledge', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_JWT_TOKEN'
  },
  body: JSON.stringify({
    type: 'semantic_model',
    data: {
      semanticModelId: 'model_001',
      databaseName: 'mall_demo',
      tableName: 'orders',
      content: JSON.stringify({
        table: 'orders',
        columns: [
          { name: 'order_id', type: 'int', description: '订单ID' },
          { name: 'user_id', type: 'int', description: '用户ID' }
        ]
      })
    }
  })
});
```

### 示例3: 混合检索（知识库 + 文件）

```javascript
const response = await fetch('/api/rag/query', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_JWT_TOKEN'
  },
  body: JSON.stringify({
    query: '订单统计',
    options: {
      types: ['semantic_model', 'business_knowledge'],
      fileIds: ['file_id_1', 'file_id_2'],
      topK: 10,
      useReranking: true,
      enhancedReranking: true
    }
  })
});
```

## 配置

### 环境变量

- `RAG_API_URL`: RAG API 服务地址（用于文件向量化，可选）
- `EMBEDDING_MODEL`: 嵌入模型名称（默认: 'default'）
- `RERANKER_TYPE`: 重排器类型（'jina' | 'cohere' | 'infinity' | 'none'，默认: 'none'）
- `JINA_API_KEY`: Jina 重排器 API Key（如果使用 Jina 重排器）
- `JINA_API_URL`: Jina 重排器 API URL（可选）
- `COHERE_API_KEY`: Cohere 重排器 API Key（如果使用 Cohere 重排器）
- `OPENAI_API_KEY`: OpenAI API Key（用于本地嵌入服务，如果 RAG_API_URL 不可用）

## 工作流程

1. **问题向量化**: 用户问题通过 EmbeddingService 转换为向量
2. **向量检索**: RetrievalService 从知识库和文件中检索相关内容
   - 支持多种知识类型：语义模型、QA对、同义词、业务知识
   - 支持混合检索：知识库 + 文件
3. **重排优化**: RerankingService 对检索结果进行优化排序
   - 基础重排：基于相似度分数
   - 增强重排：结合相似度、类型权重、时效性等因素

## 注意事项

1. 所有 API 端点都需要 JWT 认证
2. 知识条目是按用户隔离的，每个用户只能访问自己的知识条目
3. 向量嵌入需要时间，批量添加时建议使用批量接口
4. 重排服务是可选的，如果不需要可以设置 `useReranking: false`
5. 如果 RAG_API_URL 未配置，EmbeddingService 会尝试使用本地嵌入服务（需要 OPENAI_API_KEY）

## 文件位置

- 数据模型: `packages/data-schemas/src/schema/knowledgeBase.ts`
- 服务层: `api/server/services/RAG/`
- API 路由: `api/server/routes/rag.js`
- 控制器: `api/server/controllers/RAGController.js`
