# BeCause 执行流程文档

**版本**：2.0.0  
**最后更新**：2025-01-27

## 概述

本文档定义了 BeCause 系统的严格执行流程。**每轮对话都必须严格遵守此流程**，不得跳过任何步骤。

## 强制执行流程

```
用户输入
    ↓
STEP 0: 意图识别（强制，必须首先执行）
    ├─ 向量化用户问题
    ├─ 调用RAG服务检索知识（语义模型/QA对/业务知识）
    ├─ 使用检索结果进行意图分类
    └─ 得到意图：TEXT_TO_SQL | GENERAL | MISLEADING_QUERY
    ↓
根据意图路由到不同流程
    ↓
┌─────────────────────────────────────────────────────────────┐
│ 如果是 TEXT_TO_SQL 意图                                     │
├─────────────────────────────────────────────────────────────┤
│ STEP 1: RAG知识检索（强制执行）                             │
│   ├─ 调用 RAG API: POST /api/rag/query                     │
│   ├─ 检索类型: semantic_model, qa_pair, synonym,           │
│   │           business_knowledge                            │
│   ├─ Reranker重排序检索结果                                 │
│   └─ 提取并分类检索结果                                     │
│                                                             │
│ STEP 2: 获取数据库Schema                                    │
│   └─ 调用 database_schema 工具 (format="semantic")         │
│                                                             │
│ STEP 3: 获取SQL生成规则                                     │
│   └─ 调用 because 工具获取SQL生成规则                       │
│                                                             │
│ STEP 4: 生成SQL                                             │
│   ├─ 调用 text-to-sql 工具                                 │
│   ├─ 输入: query, semantic_models (从STEP 2)               │
│   ├─ 上下文: RAG检索的知识（从STEP 1）                      │
│   ├─ SQL规则（从STEP 3）                                    │
│   └─ 大模型生成SQL查询语句                                  │
│                                                             │
│ STEP 5: SQL合法性检测（强制执行）                           │
│   ├─ 检测SQL语法是否正确                                    │
│   ├─ 验证是否为安全的SELECT语句                            │
│   └─ 检查是否包含危险关键词                                 │
│                                                             │
│ STEP 6: 执行SQL查询                                         │
│   └─ 调用 sql_executor 工具执行SQL                         │
│                                                             │
│ STEP 7: 结果分析和归因                                      │
│   ├─ 整理返回的结果                                         │
│   ├─ 实现归因分析（说明数据来源：哪些表、哪些字段）         │
│   └─ 指引下一步查询建议                                     │
└─────────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────────┐
│ 如果是 GENERAL 意图                                         │
├─────────────────────────────────────────────────────────────┤
│ └─ 调用 because 工具: command="data-assistance"            │
│    └─ 使用RAG检索的知识回答关于数据库的一般问题              │
└─────────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────────┐
│ 如果是 MISLEADING_QUERY 意图                                │
├─────────────────────────────────────────────────────────────┤
│ └─ 调用 because 工具: command="misleading-assistance"      │
│    └─ 引导用户回到数据库查询任务，停止执行                   │
└─────────────────────────────────────────────────────────────┘
```

## 详细步骤说明

### STEP 0: 意图识别（强制，必须首先执行）

**目的**：准确判断用户查询的意图，以决定后续处理流程。

**执行步骤**：

1. **向量化用户问题**
   - 使用 EmbeddingService 对用户输入进行向量化

2. **调用RAG服务进行意图识别**
   - 调用 `because` 工具：`command="intent-classification"`, `arguments="用户查询"`
   - RAG服务会自动：
     - 检索相关语义模型（判断是否与数据库相关）
     - 检索相关QA对（参考类似问题的处理）
     - 检索业务知识（理解业务上下文）

3. **意图分类结果**
   - `TEXT_TO_SQL`：查询需要生成SQL并执行
   - `GENERAL`：关于数据库模式的一般问题
   - `MISLEADING_QUERY`：与数据库无关的查询

**重要**：
- 此步骤是**强制**的，不得跳过
- 必须在任何其他步骤之前执行
- 使用RAG检索的知识提高分类准确性

### TEXT_TO_SQL 流程

#### STEP 1: RAG知识检索（强制执行）

**目的**：检索与用户查询相关的知识，用于生成更准确的SQL。

**执行步骤**：

1. **调用RAG API**
   ```bash
   POST /api/rag/query
   {
     "query": "用户查询文本",
     "userId": "用户ID",
     "options": {
       "types": ["semantic_model", "qa_pair", "synonym", "business_knowledge"],
       "topK": 10,
       "useReranking": true
     }
   }
   ```

2. **处理检索结果**
   - 语义模型（semantic_model）：数据库表结构信息
   - QA对（qa_pair）：类似问题的SQL示例
   - 同义词（synonym）：业务术语映射
   - 业务知识（business_knowledge）：业务规则和文档

3. **Reranker重排序**
   - 使用RerankingService对检索结果进行重排序
   - 提高相关性，确保最相关的知识排在前面

#### STEP 2: 获取数据库Schema

**目的**：获取完整的数据库表结构信息。

**执行步骤**：
- 调用 `database_schema` 工具：`format="semantic"`
- 解析返回的JSON，提取 `semantic_models` 数组

#### STEP 3: 获取SQL生成规则

**目的**：获取SQL生成的规则和约束，确保生成的SQL符合规范。

**执行步骤**：
- 调用 `because` 工具获取SQL生成规则
- 规则包括：只允许SELECT、必须使用JOIN、大小写处理等

#### STEP 4: 生成SQL

**目的**：使用所有上下文信息生成SQL查询语句。

**执行步骤**：

1. **准备上下文**
   - RAG检索的知识（从STEP 1）
   - 数据库Schema（从STEP 2）
   - SQL生成规则（从STEP 3）

2. **调用text-to-sql工具**
   - 输入：`query`（用户查询）, `semantic_models`（数据库Schema）
   - 上下文：RAG检索的知识会填充到提示词变量中
   - 使用Jinja2模板替换变量，构造最终Prompt

3. **大模型生成SQL**
   - 调用LLM生成SQL查询语句
   - 使用所有上下文信息确保准确性

#### STEP 5: SQL合法性检测（强制执行）

**目的**：确保SQL语句安全、合法，不会对数据库造成损害。

**执行步骤**：

1. **语法检测**
   - 检查SQL语法是否正确

2. **安全性检测**
   - 验证是否为SELECT语句（不允许INSERT/UPDATE/DELETE/DROP等）
   - 检查是否包含危险关键词

3. **验证结果**
   - 如果检测失败，返回错误，不执行SQL
   - 如果检测通过，继续执行

#### STEP 6: 执行SQL查询

**目的**：执行已验证的SQL查询，获取数据结果。

**执行步骤**：
- 调用 `sql_executor` 工具
- 输入：`sql`（已验证的SQL语句）
- 返回：查询结果、行数统计、归因分析

#### STEP 7: 结果分析和归因

**目的**：分析查询结果，提供清晰的归因说明和下一步建议。

**执行步骤**：

1. **整理返回的结果**
   - 解析查询结果数据
   - 提取行数统计

2. **实现归因分析**
   - 说明数据来源：哪些表、哪些字段
   - 说明过滤条件、分组条件、排序条件
   - 清晰展示数据是如何计算得出的

3. **指引下一步查询建议**
   - 基于当前结果，建议可能的后续查询
   - 帮助用户深入探索数据

### GENERAL 流程

当意图分类结果为 `GENERAL` 时：

- 调用 `because` 工具：`command="data-assistance"`
- 使用RAG检索的知识回答关于数据库的一般问题
- 不需要生成或执行SQL

### MISLEADING_QUERY 流程

当意图分类结果为 `MISLEADING_QUERY` 时：

- 调用 `because` 工具：`command="misleading-assistance"`
- 引导用户回到数据库查询任务
- **停止执行**，不再继续处理其他步骤

## 关键规则

1. **意图识别是强制的**：每轮对话必须首先执行意图识别（STEP 0）
2. **不得跳过步骤**：所有步骤必须按顺序执行
3. **RAG优先**：优先使用RAG检索的知识，而不是传统变量
4. **SQL安全验证**：必须验证SQL合法性后才能执行
5. **结果归因**：必须提供清晰的数据来源说明

## 常见错误

### ❌ 错误：跳过意图识别

**问题**：直接执行SQL生成或执行，没有先进行意图识别。

**解决**：确保每轮对话都首先调用 `because` 工具进行意图识别。

### ❌ 错误：跳过RAG检索

**问题**：在生成SQL时没有使用RAG检索的知识。

**解决**：在生成SQL前必须调用RAG API检索相关知识。

### ❌ 错误：跳过SQL验证

**问题**：生成SQL后直接执行，没有验证安全性。

**解决**：必须验证SQL合法性和安全性后才能执行。

### ❌ 错误：直接执行sql_executor

**问题**：没有经过意图识别、RAG检索、SQL生成等步骤，直接调用sql_executor。

**解决**：必须严格按照流程执行，sql_executor只能在STEP 6执行。

## 相关文档

- [命令模板](../commands/agentic/main-agent.md)
- [工具使用说明](./TOOL_USAGE.md)
- [RAG服务集成说明](./README.md#rag-服务集成)

